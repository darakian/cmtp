\documentclass[a4paper,11pt]{article}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}

\title{The Cipher Mail Transport Protocol Interface}
\author{Jonathan Moroney}

\begin{document}

\maketitle
\tableofcontents

%\begin{abstract}
%\end{abstract}

\section{Command Overview}
The Cipher Mail Transport Protocol (CMTP) uses a text based, command/reply interface similar to that of the Simple Mail Transport Protocol (SMTP). The commands for CMTP have been designed to make stateless implementation easy. All commands are ASCII strings terminated by a null character (\textbackslash 0). ASCII is used over utf-8 for commands as each ASCII character corresponds to one byte.
%
%
% \begin{description}
%   \item [OHAI] \hfill \\
%   This command is used to identify a CMTP client to a CMTP server. This is the CMTP analog to SMTPs HELO/EHLO though there are no parameters that follow.
%   \item [MAIL] \hfill \\
%   This command is used to initiate a mail transfer. After the command is issued the CMTP server should expect a self describing CMTP message to follow and should reply after it has been received.
%   \item [KEYREQUEST <USER> <DOMAIN>] \hfill \\
%   This command is used to request a public key for some user on some domain. The parameters USER and DOMAIN are null terminated.
%   \item [NOOP] \hfill \\
%   This command does nothing but prompt a reply from the CMTP server.
%   \item [LOGIN <USER>] \hfill \\
%   This command is used to initiate a user login.
%   \item [HELP] \hfill \\
%   This command is used by users that need to RTFM.
%   \item [OBAI] \hfill \\
%   This command is used to terminate a connection.
% \end{description}
%
% \section{Deep Dive}
\subsection{OHAI}
The OHAI command is in place to prevent SMTP clients from seeing a CMTP server as a valid SMTP server. Conveniently OHAI is four characters long which should mean even the oldest SMTP client should fail in a defined way when attempting to connect to a CMTP server.
\subsection{MAIL}
The MAIL command is a stand alone command which servers only to tell the CMTP server that a message is to follow. The CMTP message is self describing in length so that a server knows when it has received the entire thing. Subsequently no state is needed in order to pass a message.
\subsection{KEYREQUEST <USER> <DOMAIN>}
The KEYREQUEST command takes at least one parameter and at most two. The user parameter is required while the domain parameter is not. Each parameter is null terminated. In the case that the domain parameter is not present the CMTP server should assume that the user is local to it. The reply format is \newline
[Version][UserPublicKey][\textbackslash 0][ServerSigOfKey][\textbackslash 0]. \newline
Errors and messages use a similar reply format but with the Version = 0 which corresponds to the plaintext crypto case \newline
[Version][Message][\textbackslash 0][ServerSigOfMessage][\textbackslash 0]. \newline
In this way delays and 'no key' messages can be passed back to the client. Currently the only error message is
\begin{description}
  \item [KEYNOTAVAILABLE] \hfill \\
   Used as a reply if requested key does not exist. On the wire this looks like [Version][KEYNOTAVAILABLE][\textbackslash 0][ServerSigOfMessage][\textbackslash 0]
\end{description}
\subsection{NOOP}
The NOOP command exists because SMTP has a NOOP command. This may be removed if a better reason for existence cannot be found.
\subsection{LOGIN <USER>}
The LOGIN command takes one parameter and returns an encrypted copy of the users private key along with a clear text message which the server expects the user to sign and return. The private key is encrypted with a symmetric cipher and so signing the clear text message is sufficient to verify a user login. The message can be randomly generated on each login attempt to prevent replay attacks.
\subsection{HELP}
The help command exists because people will be dumb given the chance and in that inevitability the help command is here to... help.
\subsection{OBAI}
The OBAI command is in place to terminate a connection. Connections may terminate for other reasons (time outs, tcp connection breaking, etc...), but OBAI allows for a graceful exit. 

\end{document}
