\documentclass[a4paper,11pt]{article}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}

\title{The Cipher Mail Transport Protocol Interface}
\author{Jonathan Moroney}

\begin{document}

\maketitle
\tableofcontents

%\begin{abstract}
%\end{abstract}

\section{Command Overview}
The Cipher Mail Transport Protocol (CMTP) uses a text based, command/reply interface similar to that of the Simple Mail Transport Protocol (SMTP). The commands for CMTP have been designed to make stateless implementation easy. All commands are ASCII strings terminated by a null character (\textbackslash 0). ASCII is used over utf-8 for commands as each ASCII character corresponds to one byte.
%
%
% \begin{description}
%   \item [OHAI] \hfill \\
%   This command is used to identify a CMTP client to a CMTP server. This is the CMTP analog to SMTPs HELO/EHLO though there are no parameters that follow.
%   \item [MAIL] \hfill \\
%   This command is used to initiate a mail transfer. After the command is issued the CMTP server should expect a self describing CMTP message to follow and should reply after it has been received.
%   \item [KEYREQUEST <USER> <DOMAIN>] \hfill \\
%   This command is used to request a public key for some user on some domain. The parameters USER and DOMAIN are null terminated.
%   \item [NOOP] \hfill \\
%   This command does nothing but prompt a reply from the CMTP server.
%   \item [LOGIN <USER>] \hfill \\
%   This command is used to initiate a user login.
%   \item [HELP] \hfill \\
%   This command is used by users that need to RTFM.
%   \item [OBAI] \hfill \\
%   This command is used to terminate a connection.
% \end{description}
%
% \section{Deep Dive}
\subsection{OHAI}
The OHAI command is in place to prevent SMTP clients from seeing a CMTP server as a valid SMTP server. Conveniently OHAI is four characters long which should mean even the oldest SMTP client should fail in a defined way when attempting to connect to a CMTP server.
\subsection{MAIL}
The MAIL command is a stand alone command which servers only to tell the CMTP server that a message is to follow. The CMTP message is self describing in length so that a server knows when it has received the entire thing. Subsequently no state is needed in order to pass a message.
\begin{description}
  \item [DELIVERYFAILURE] \hfill \\
   Used as a reply if mail cannot be delivered. Failure to deliver can be due to forwarding not being allowed, account not found or destination server not found. On the wire this looks like [Version][DELIVERYFAILURE][\textbackslash 0][ServerSigOfMessage][\textbackslash 0]
\end{description}
\subsection{KEYREQUEST <USER> <DOMAIN>}
The KEYREQUEST command takes at least one parameter and at most two. The user parameter is required while the domain parameter is not. Each parameter is null terminated. In the case that the domain parameter is not present the CMTP server should assume that the user is local to it. The reply format is \newline
[Version][UserPublicKey][\textbackslash 0][ServerSigOfKey][\textbackslash 0]. \newline
Errors and messages use a similar reply format but with the Version = 0 which corresponds to the plaintext crypto case \newline
[Version][Message][\textbackslash 0][ServerSigOfMessage][\textbackslash 0]. \newline
In this way delays and 'no key' messages can be passed back to the client. Currently the only error message is
\begin{description}
  \item [KEYNOTAVAILABLE] \hfill \\
   Used as a reply if requested key does not exist. On the wire this looks like [Version][KEYNOTAVAILABLE][\textbackslash 0][ServerSigOfMessage][\textbackslash 0]
\end{description}
\subsection{NOOP}
The NOOP command exists because SMTP has a NOOP command. This may be removed if a better reason for existence cannot be found.
\subsection{LOGIN <USER>}
The LOGIN command takes one parameter and returns an encrypted copy of the users xzibit. The xzibit is the encrypted private key for the user. If authentication is desired a user reply can be implemented which has the user encrypt their exhibit with the server's public key and forwards that back to the server. This is currently not implemented. Version one defines the reply as 
\newline
[Version][XzibitLength][Xzibit][ServerSigofXzibit]
Field lengths are as follows.
\begin{itemize}
  \item Version: 4 bytes
  \item XzibitLength: 4 bytes
  \item Xzibit: Length defined by XzibitLength. XzibitLength*(1 byte).
  \item ServerSigofXzibit: Defined by crypto version. In version 1 signatures are 64 bytes long.
\end{itemize}
\subsection{OBAI}
The OBAI command is in place to terminate a connection. Connections may terminate for other reasons (time outs, tcp connection breaking, etc...), but OBAI allows for a graceful exit. 

\section{General Responses}
There are two general responses that follow the general message structure.
\begin{description}
  \item [SUCCESS] \hfill \\
  Used to indicate that a command was recived and processed.
  [SUCCESS][\textbackslash 0][ServerSigOfMessage][\textbackslash 0]
  \item [FAILURE] \hfill \\
  Used to indicate that a command was recived and not processed.
  [FAILURE][\textbackslash 0][ServerSigOfMessage][\textbackslash 0]
\end{description}
\end{document}
